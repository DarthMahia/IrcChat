@page "/chat"
@using IrcChat.Shared.Models
@using IrcChat.Client.Services
@using IrcChat.Client.Components
@inject HttpClient Http
@inject ChatService ChatService
@inject UnifiedAuthService Auth
@inject PrivateMessageService PrivateMessageService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>IRC Chat</PageTitle>

@if (!isInitialized)
{
    <div class="loading">
        <div class="spinner"></div>
        <p>Chargement...</p>
    </div>
}
else if (!Auth.HasUsername)
{
    <p>Redirection vers la page de connexion...</p>
}
else
{
    <div class="chat-container">
        <Sidebar Username="@currentUsername"
                 AvatarUrl="@avatarUrl"
                 IsOAuthUser="@Auth.IsReserved"
                 CurrentChannel="@currentChannel"
                 Channels="@channels"
                 Users="@users"
                 PrivateConversations="@privateConversations"
                 SelectedPrivateUser="@selectedPrivateUser"
                 OnChannelSelected="SwitchChannel"
                 OnChannelCreated="CreateChannel"
                 OnUserClicked="OpenPrivateChat"
                 OnPrivateConversationSelected="OpenPrivateChat"
                 OnLogoutClicked="Logout"
                 OnForgetUsernameClicked="ForgetUsername" />

        <ChatArea Username="@currentUsername"
                  CurrentChannel="@currentChannel"
                  IsConnected="@isConnected"
                  Messages="@messages"
                  Users="@users"
                  OnMessageSent="SendMessage" />
    </div>

    @if (showPrivateChat && !string.IsNullOrEmpty(selectedPrivateUser))
    {
        <PrivateChatWindow CurrentUsername="@currentUsername"
                           OtherUsername="@selectedPrivateUser"
                           Messages="@privateMessages"
                           IsConnected="@isConnected"
                           OnSendMessage="SendPrivateMessage"
                           OnClose="ClosePrivateChat" />
    }
}

@code {
    private string currentChannel = "";
    private string currentUsername = "";
    private string? avatarUrl = null;
    private List<Message> messages = new();
    private List<Channel> channels = new();
    private List<User> users = new();
    private bool isConnected = false;
    private bool isInitialized = false;

    // Messages privés
    private List<PrivateConversation> privateConversations = new();
    private List<PrivateMessage> privateMessages = new();
    private string? selectedPrivateUser = null;
    private bool showPrivateChat = false;

    protected override async Task OnInitializedAsync()
    {
        await Auth.InitializeAsync();
        isInitialized = true;

        if (!Auth.HasUsername)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUsername = Auth.Username!;
        avatarUrl = Auth.AvatarUrl;

        if (!string.IsNullOrEmpty(currentUsername))
        {
            if (Auth.IsAuthenticated && !string.IsNullOrEmpty(Auth.Token))
            {
                Http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            await LoadChannels();
            await InitializeSignalR();
            await LoadPrivateConversations();
        }
    }

    private async Task InitializeSignalR()
    {
        ChatService.OnMessageReceived += OnMessageReceived;
        ChatService.OnUserJoined += OnUserJoined;
        ChatService.OnUserLeft += OnUserLeft;
        ChatService.OnUserListUpdated += OnUserListUpdated;

        PrivateMessageService.OnPrivateMessageReceived += OnPrivateMessageReceived;
        PrivateMessageService.OnPrivateMessageSent += OnPrivateMessageSent;
        PrivateMessageService.OnUnreadCountChanged += OnUnreadCountChanged;

        try
        {
            await ChatService.InitializeAsync(Auth.Token);
            isConnected = true;
            StateHasChanged();
        }
        catch
        {
            isConnected = false;
        }
    }

    // Handlers pour canaux publics
    private void OnMessageReceived(Message message)
    {
        if (message.Channel == currentChannel)
        {
            messages.Add(message);
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserJoined(string user, string channel)
    {
        if (channel == currentChannel)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserLeft(string user, string channel)
    {
        if (channel == currentChannel)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserListUpdated(List<User> updatedUsers)
    {
        users = updatedUsers;
        InvokeAsync(StateHasChanged);
    }

    // Handlers pour messages privés
    private void OnPrivateMessageReceived(PrivateMessage message)
    {
        if (message.SenderUsername == selectedPrivateUser || message.RecipientUsername == selectedPrivateUser)
        {
            privateMessages.Add(message);

            if (showPrivateChat && message.SenderUsername == selectedPrivateUser)
            {
                _ = ChatService.MarkPrivateMessagesAsRead(selectedPrivateUser);
            }
        }

        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    private void OnPrivateMessageSent(PrivateMessage message)
    {
        if (message.RecipientUsername == selectedPrivateUser)
        {
            privateMessages.Add(message);
        }

        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    private void OnUnreadCountChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    // Actions
    private async Task Logout()
    {
        if (!string.IsNullOrEmpty(currentChannel))
        {
            await ChatService.LeaveChannel(currentChannel);
        }

        currentChannel = "";
        channels.Clear();
        messages.Clear();
        users.Clear();
        isConnected = false;

        await Auth.ClearAllAsync();
        Http.DefaultRequestHeaders.Authorization = null;

        Navigation.NavigateTo("/login");
    }

    private async Task ForgetUsername()
    {
        if (!Auth.IsReserved) return;

        // 1. Quitter le canal et déconnecter le Hub (avant d'oublier)
        if (!string.IsNullOrEmpty(currentChannel))
        {
            await ChatService.LeaveChannel(currentChannel);
        }

        // 2. Appel de la nouvelle méthode de déconnexion complète
        await Auth.ForgetUsernameAndLogoutAsync();

        // 3. Nettoyage de l'état local et de la connexion HTTP
        currentChannel = "";
        // ... Nettoyage des listes ...
        isConnected = false;
        Http.DefaultRequestHeaders.Authorization = null;

        // 4. Redirection vers la page de login
        Navigation.NavigateTo("/login");
    }

    private async Task CreateChannel(string channelName)
    {
        var channel = new Channel
        {
            Name = channelName,
            CreatedBy = currentUsername,
        };

        try
        {
            await Http.PostAsJsonAsync("/api/channels", channel);
            await LoadChannels();
            await SwitchChannel(channelName);
        }
        catch { }
    }

    private async Task SwitchChannel(string channel)
    {
        if (!string.IsNullOrEmpty(currentChannel))
        {
            await ChatService.LeaveChannel(currentChannel);
        }

        currentChannel = channel;
        await LoadMessages();
        await ChatService.JoinChannel(currentUsername, channel);
    }

    private async Task LoadChannels()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<Channel>>("/api/channels");
            if (result != null)
            {
                channels = result;
            }
        }
        catch { }
    }

    private async Task LoadMessages()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<Message>>($"/api/messages/{currentChannel}");
            if (result != null)
            {
                messages = result;
            }
        }
        catch { }
    }

    private async Task SendMessage(string content)
    {
        if (!string.IsNullOrEmpty(currentUsername) && isConnected)
        {
            var req = new SendMessageRequest
            {
                Username = currentUsername,
                Content = content,
                Channel = currentChannel
            };

            try
            {
                await ChatService.SendMessage(req);
            }
            catch { }
        }
    }

    // Méthodes pour messages privés
    private async Task LoadPrivateConversations()
    {
        privateConversations = await PrivateMessageService.GetConversationsAsync(currentUsername);
    }

    private async Task OpenPrivateChat(string username)
    {
        selectedPrivateUser = username;
        showPrivateChat = true;

        privateMessages = await PrivateMessageService.GetPrivateMessagesAsync(currentUsername, username);

        await ChatService.MarkPrivateMessagesAsRead(username);
        await LoadPrivateConversations();

        StateHasChanged();
    }

    private void ClosePrivateChat()
    {
        showPrivateChat = false;
        selectedPrivateUser = null;
        privateMessages.Clear();
        StateHasChanged();
    }

    private async Task SendPrivateMessage(string content)
    {
        if (string.IsNullOrEmpty(selectedPrivateUser) || !isConnected)
            return;

        var request = new SendPrivateMessageRequest
        {
            SenderUsername = currentUsername,
            RecipientUsername = selectedPrivateUser,
            Content = content
        };

        try
        {
            await ChatService.SendPrivateMessage(request);
        }
        catch { }
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.OnMessageReceived -= OnMessageReceived;
        ChatService.OnUserJoined -= OnUserJoined;
        ChatService.OnUserLeft -= OnUserLeft;
        ChatService.OnUserListUpdated -= OnUserListUpdated;

        PrivateMessageService.OnPrivateMessageReceived -= OnPrivateMessageReceived;
        PrivateMessageService.OnPrivateMessageSent -= OnPrivateMessageSent;
        PrivateMessageService.OnUnreadCountChanged -= OnUnreadCountChanged;

        await ChatService.DisposeAsync();
    }
}