@page "/"
@page "/chat"
@using IrcChat.Shared.Models
@using IrcChat.Client.Services
@using IrcChat.Client.Components
@inject HttpClient Http
@inject ChatService ChatService
@inject UserSessionService UserSession
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>IRC Chat</PageTitle>

@if (!UserSession.IsLoggedIn)
{
    Navigation.NavigateTo("/login");
}
else
{
    <div class="chat-container">
        <Sidebar Username="@UserSession.Username"
                 CurrentChannel="@currentChannel"
                 Channels="@channels"
                 Users="@users"
                 OnChannelSelected="SwitchChannel"
                 OnChannelCreated="CreateChannel"
                 OnLogoutClicked="Logout" />

        <ChatArea Username="@UserSession.Username"
                  CurrentChannel="@currentChannel"
                  IsConnected="@isConnected"
                  Messages="@messages"
                  OnMessageSent="SendMessage" />
    </div>
}

@code {
    private string currentChannel = string.Empty;
    private List<Message> messages = new();
    private List<Channel> channels = new();
    private List<User> users = new();
    private bool isConnected = false;

    protected override async Task OnInitializedAsync()
    {
        if (UserSession.IsLoggedIn)
        {
            await LoadChannels();
            await InitializeSignalR();
        }
    }

    private async Task InitializeSignalR()
    {
        ChatService.OnMessageReceived += OnMessageReceived;
        ChatService.OnUserJoined += OnUserJoined;
        ChatService.OnUserLeft += OnUserLeft;
        ChatService.OnUserListUpdated += OnUserListUpdated;

        try
        {
            await ChatService.InitializeAsync();
            isConnected = true;
            StateHasChanged();
        }
        catch
        {
            isConnected = false;
        }
    }

    private void OnMessageReceived(Message message)
    {
        if (message.Channel == currentChannel)
        {
            messages.Add(message);
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserJoined(string user, string channel)
    {
        if (channel == currentChannel)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserLeft(string user, string channel)
    {
        if (channel == currentChannel)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserListUpdated(List<User> updatedUsers)
    {
        users = updatedUsers;
        InvokeAsync(StateHasChanged);
    }

    private async Task Logout()
    {
        if (!string.IsNullOrEmpty(currentChannel))
        {
            await ChatService.LeaveChannel(currentChannel);
        }
        
        currentChannel = "";
        channels.Clear();
        messages.Clear();
        users.Clear();
        isConnected = false;
        
        UserSession.ClearSession();
        Navigation.NavigateTo("/login");
    }

    private async Task CreateChannel(string channelName)
    {
        var channel = new Channel { Name = channelName };
        
        try
        {
            await Http.PostAsJsonAsync("/api/channels", channel);
            await LoadChannels();
            await SwitchChannel(channelName);
        }
        catch { }
    }

    private async Task SwitchChannel(string channel)
    {
        if (!string.IsNullOrEmpty(currentChannel))
        {
            await ChatService.LeaveChannel(currentChannel);
        }

        currentChannel = channel;
        await LoadMessages();
        await ChatService.JoinChannel(UserSession.Username ?? "", channel);
    }

    private async Task LoadChannels()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<Channel>>("/api/channels");
            if (result != null)
            {
                channels = result;
            }
        }
        catch { }
    }

    private async Task LoadMessages()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<Message>>($"/api/messages/{currentChannel}");
            if (result != null)
            {
                messages = result;
            }
        }
        catch { }
    }

    private async Task SendMessage(string content)
    {
        if (UserSession.IsLoggedIn && isConnected)
        {
            var req = new SendMessageRequest
            {
                Username = UserSession.Username ?? "",
                Content = content,
                Channel = currentChannel
            };

            try
            {
                await ChatService.SendMessage(req);
            }
            catch { }
        }
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.OnMessageReceived -= OnMessageReceived;
        ChatService.OnUserJoined -= OnUserJoined;
        ChatService.OnUserLeft -= OnUserLeft;
        ChatService.OnUserListUpdated -= OnUserListUpdated;
        
        await ChatService.DisposeAsync();
    }
}